name: Pre-commit

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version, default is 3.12.x
        required: false
        type: string
        default: 3.12.x
      cache:
        description: Package manager to cache from pip, pipenv and poetry
        required: false
        type: string

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.python-version }}
        cache: ${{ inputs.cache }}

    - name: Install pre-commit
      run: pip install pre-commit

    - name: Run pre-commit hooks on all files
      run: pre-commit run --all-files --show-diff-on-failure | tee output.txt

    - name: Display results in the GitHub Actions summary
      id: pre-commit
      run: |
        output=$(cat output.txt)

        # Exclude lines that don't end with Passed, Skipped or Failed
        output=$(echo "$output" | grep -E 'Passed|Skipped|Failed')

        output=$(echo "$output" | sed 's/Passed/:white_check_mark:/g')
        output=$(echo "$output" | sed 's/Skipped/:ballot_box_with_check:/g')
        output=$(echo "$output" | sed 's/Failed/:x:/g')

        # Use awk to format the output into a markdown table, removing the dots
        output=$(echo "$output" | awk -F':' '{gsub(/\.+/, "", $1); print "| " $1 " | :" $2 ":|"}')

        echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
        echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
        echo "$output" >> $GITHUB_STEP_SUMMARY
      shell: bash
